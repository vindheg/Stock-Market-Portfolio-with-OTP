<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - Stock Portfolio</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@500&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; overflow: hidden; background: #0d0d0f; color: #e2e2e8; }
    h2 { font-family: 'Poppins', sans-serif; }
    .glass-card { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); border:1px solid rgba(255,255,255,0.08); box-shadow:0 0 25px rgba(0,0,0,0.45); }
    .input-box { background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); color: #e7e7e9; }
    .input-box::placeholder { color: #a1a1a8; }
    .primary-btn { background: #4040ff; color: white; transition: 0.2s; }
    .primary-btn:hover { background: #2a2aff; box-shadow: 0 0 20px rgba(64,64,255,0.4); }
    canvas { position: fixed; top:0; left:0; width:100%; height:100%; z-index:0; }
    .msg { font-size: 0.85rem; margin-top: 0.4rem; }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center relative">
  <canvas id="particles"></canvas>

  <div class="glass-card relative z-10 w-full max-w-md p-10 rounded-2xl">
    <h2 class="text-3xl text-center text-white font-semibold mb-8 tracking-wide">Welcome Back</h2>

    <form id="login-form" class="space-y-6">
      <div id="login-fields">
        <div>
          <label class="block text-sm font-semibold text-gray-300 mb-2">Username</label>
          <input type="text" id="username" class="input-box w-full px-4 py-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter username" required />
          <p id="username-msg" class="msg text-red-400 hidden"></p>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-300 mb-2">Password</label>
          <input type="password" id="password" class="input-box w-full px-4 py-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter password" required />
          <p id="password-msg" class="msg text-red-400 hidden"></p>
        </div>

        <button type="submit" id="login-btn" class="primary-btn w-full py-3 rounded-lg font-semibold shadow-md">Login</button>
      </div>

      <div id="otp-section" style="display:none;">
        <div>
          <label class="block text-sm font-semibold text-gray-300 mb-2">Enter OTP</label>
          <input type="text" id="otp" class="input-box w-full px-4 py-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="6-digit OTP" maxlength="6" />
          <p id="otp-msg" class="msg text-red-400 hidden"></p>
        </div>

        <div class="flex gap-3">
          <button type="button" id="verify-otp-btn" class="primary-btn flex-1 py-3 rounded-lg font-semibold shadow-md">Verify OTP</button>
          <button type="button" id="resend-otp-btn" class="w-36 py-3 rounded-lg font-semibold border border-gray-600 text-gray-300">Resend</button>
        </div>

        <p id="resend-timer" class="msg text-gray-400 hidden"></p>
        <p id="otp-success" class="msg text-green-400 hidden"></p>
      </div>
    </form>

  </div>

<script>
  // === CONFIG: set your live backend URL here ===
  const BACKEND_HOST = "https://stock-market-portfolio-with-otp.onrender.com";
  // ==============================================

  // Elements
  const loginFields = document.getElementById("login-fields");
  const otpSection = document.getElementById("otp-section");
  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");
  const otpInput = document.getElementById("otp");

  const loginBtn = document.getElementById("login-btn");
  const verifyBtn = document.getElementById("verify-otp-btn");
  const resendBtn = document.getElementById("resend-otp-btn");

  const usernameMsg = document.getElementById("username-msg");
  const passwordMsg = document.getElementById("password-msg");
  const otpMsg = document.getElementById("otp-msg");
  const resendTimer = document.getElementById("resend-timer");
  const otpSuccess = document.getElementById("otp-success");

  let resendCooldown = 30; // seconds
  let resendInterval = null;

  function showInline(el, text, colorClass="text-red-400") {
    el.textContent = text;
    el.classList.remove("hidden");
    el.classList.remove("text-green-400","text-gray-400","text-red-400");
    el.classList.add(colorClass);
  }
  function hideInline(el) { el.classList.add("hidden"); el.textContent = ""; }

  // start resend cooldown
  function startResendCooldown() {
    resendBtn.disabled = true;
    resendBtn.classList.add("opacity-60", "cursor-not-allowed");
    let t = resendCooldown;
    resendTimer.classList.remove("hidden");
    resendTimer.textContent = `You can resend in ${t}s`;
    resendInterval = setInterval(() => {
      t--;
      if (t <= 0) {
        clearInterval(resendInterval);
        resendTimer.classList.add("hidden");
        resendBtn.disabled = false;
        resendBtn.classList.remove("opacity-60","cursor-not-allowed");
      } else {
        resendTimer.textContent = `You can resend in ${t}s`;
      }
    }, 1000);
  }

  // handle login → request OTP
  document.getElementById("login-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    hideInline(usernameMsg); hideInline(passwordMsg); hideInline(otpMsg); hideInline(otpSuccess);

    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();

    if (username.length < 3) { showInline(usernameMsg, "Username must be at least 3 characters."); return; }
    if (password.length < 1) { showInline(passwordMsg, "Password required."); return; }

    loginBtn.disabled = true;
    loginBtn.textContent = "Sending OTP...";

    try {
      const resp = await fetch(`${BACKEND_HOST}/api/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      const data = await resp.json();

      if (data.status === "otp_sent") {
        // show OTP UI
        sessionStorage.setItem("username", username);
        loginFields.style.display = "none";
        otpSection.style.display = "block";
        showInline(otpSuccess, "OTP sent — check your email.", "text-green-400");
        startResendCooldown();
      } else {
        showInline(usernameMsg, data.message || "Login failed");
      }
    } catch (err) {
      showInline(usernameMsg, "Network error — try again");
    } finally {
      loginBtn.disabled = false;
      loginBtn.textContent = "Login";
    }
  });

  // verify OTP
  verifyBtn.addEventListener("click", async () => {
    hideInline(otpMsg); hideInline(otpSuccess);
    const username = sessionStorage.getItem("username");
    const otp = otpInput.value.trim();

    if (!username) { showInline(otpMsg, "Session expired — please login again."); return; }
    if (!otp || otp.length < 4) { showInline(otpMsg, "Enter a valid OTP."); return; }

    verifyBtn.disabled = true;
    verifyBtn.textContent = "Verifying...";

    try {
      const resp = await fetch(`${BACKEND_HOST}/api/auth/verify-otp`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, otp })
      });
      const data = await resp.json();

      if (data.status === "success") {
        showInline(otpSuccess, "OTP verified — Redirecting...", "text-green-400");
        // a short delay so user sees success then redirect
        setTimeout(() => {
          sessionStorage.setItem("username", username); // keep username for portfolio
          otpInput.value = "";
          window.location.href = "portfolio.html";
        }, 900);
      } else {
        showInline(otpMsg, data.message || "Incorrect OTP");
      }
    } catch (err) {
      showInline(otpMsg, "Network error — try again");
    } finally {
      verifyBtn.disabled = false;
      verifyBtn.textContent = "Verify OTP";
    }
  });

  // resend OTP (calls the same login endpoint)
  resendBtn.addEventListener("click", async () => {
    hideInline(otpMsg); hideInline(otpSuccess);
    const username = sessionStorage.getItem("username");
    if (!username) { showInline(otpMsg, "Session expired — please login again."); return; }

    resendBtn.disabled = true;
    resendBtn.textContent = "Resending...";

    try {
      const resp = await fetch(`${BACKEND_HOST}/api/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password: "placeholder" }) // password ignored on server
      });
      const data = await resp.json();
      if (data.status === "otp_sent") {
        showInline(otpSuccess, "OTP resent. Check your email.", "text-green-400");
        startResendCooldown();
      } else {
        showInline(otpMsg, data.message || "Failed to resend OTP");
        // allow retry quickly
        resendBtn.disabled = false;
        resendBtn.textContent = "Resend";
      }
    } catch (err) {
      showInline(otpMsg, "Network error — try again");
      resendBtn.disabled = false;
      resendBtn.textContent = "Resend";
    }
  });

  // small accessibility: press Enter in OTP input to verify
  otpInput.addEventListener("keydown", (e) => { if (e.key === "Enter") verifyBtn.click(); });

</script>

<!-- Particles (unchanged) -->
<script>
  const canvas = document.getElementById("particles");
  const ctx = canvas.getContext("2d");
  let particlesArray; const numParticles = 60;
  function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
  window.addEventListener("resize", resizeCanvas); resizeCanvas();
  class Particle { constructor(){ this.x=Math.random()*canvas.width; this.y=Math.random()*canvas.height; this.size=Math.random()*3+1; this.speedX=(Math.random()-0.5)*0.4; this.speedY=(Math.random()-0.5)*0.4; this.color=`rgba(64,64,255,${Math.random()*0.4+0.2})`; } update(){ this.x+=this.speedX; this.y+=this.speedY; if(this.x<0||this.x>canvas.width) this.speedX*=-1; if(this.y<0||this.y>canvas.height) this.speedY*=-1; } draw(){ ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fillStyle=this.color; ctx.fill(); } }
  function initParticles(){ particlesArray=[]; for(let i=0;i<numParticles;i++) particlesArray.push(new Particle()); }
  function animateParticles(){ ctx.clearRect(0,0,canvas.width,canvas.height); particlesArray.forEach(p=>{p.update();p.draw();}); requestAnimationFrame(animateParticles); }
  initParticles(); animateParticles();
</script>
</body>
</html>
